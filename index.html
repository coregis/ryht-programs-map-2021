<!DOCTYPE html>
<html>

<!--
	WHERE THINGS ARE DEFINED IN THIS FILE:

	Layers are added in the map.on('load') call towards the end.

	For a layer to appear in the legend, it must have a corresponding <li> in <ul class='legend-labels'>, and the id for that item has to be given to addPointLayer() or addVectorLayer() as the legendID property.
	For a legend item to show the right icon, there must be a corresponding rule set in css/ryht-legislative-style.css

	For a layer to appear in the Zoom to Districts control, it must have a polygon layer (even if that's kept invisible) and have two corresponding definitions:
		1) a <select> element defined in the section of <div id="mySidenav"> that's labelled with the comment: !--Drop down controls--
		2) a populateZoomControl() line in the runWhenLoadComplete() function
-->

	<head>
		<meta charset='utf-8' />
		<title>Raise Your Hand Texas programs</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
		<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />
		<link href="css/ryht-legislative-style.css" rel="stylesheet" />
		<style>
			body { margin:0; padding:0; }
			#map { position:absolute; top:0; bottom:0; width:100%; }
			.mapboxgl-popup {
				max-width: 400px;
				font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
			}
		</style>

		<script>
			// store this as a global variable so that the stats box can always access the current value
			var activeDistrict = '0';
			// first we check for the URL parameter '?districts=senate'.  If found, we'll show state senate districts; otherwise state house
			var urlParams = {};
			window.location.href.replace(
				/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {urlParams[key] = value;}
			);
			var showHouseDistricts = true;
			var showSenateDistricts = false;
			if (
				(
					urlParams["districts"] && (
						urlParams["districts"].toLowerCase().indexOf("sen") > -1
						||
						urlParams["districts"].toLowerCase() === 's'
					)
				) || (
					urlParams["Districts"] && (
						urlParams["Districts"].toLowerCase().indexOf("sen") > -1
						||
						urlParams["Districts"].toLowerCase() === 's'
					)
				) || (
					urlParams["display"] && (
						urlParams["display"].toLowerCase().indexOf("sen") > -1
						||
						urlParams["display"].toLowerCase() === 's'
					)
				) || (
					urlParams["Display"] && (
						urlParams["Display"].toLowerCase().indexOf("sen") > -1
						||
						urlParams["Display"].toLowerCase() === 's'
					)
				)
			) {
				showHouseDistricts = false;
				showSenateDistricts = true;
			}
			// now we can check the two showXDistricts variables anywhere that we might introduce House or Senate districts to decide which one to show

			function showHideLayer(layerName, markerName, showOnly=false, hideOnly=false) {
				var visibility = map.getLayoutProperty(layerName, 'visibility');
					if ((visibility === 'visible' || hideOnly) && !showOnly) {
						map.setLayoutProperty(layerName, 'visibility', 'none');
						this.className = '';
						document.getElementById(markerName).classList.add('inactive');
					} else {
						this.className = 'active';
						map.setLayoutProperty(layerName, 'visibility', 'visible');
						document.getElementById(markerName).classList.remove('inactive');
				}
			}

	//These are the four functions written by Eldan that power the zoom-to-district feature
	// runWhenLoadComplete() checks if the map has finished loading data, and once it has then it calls the next one.
	//populateZoomControl() fills the dropdowns with options generated from reading the data layers for all the district names.
	//getPolygons() does the actual work of fetching the district names
	//zoomToPolygon() zooms the map to the district extent

			function runWhenLoadComplete() {
				if (!map.getLayer('raising-school-leaders-points')) {
					setTimeout(runWhenLoadComplete, 100);
				}
				else {
					if (showHouseDistricts) {
						populateZoomControl("house-districts-control", "state-house-districts", "District", "Texas House Districts");
						map.moveLayer('state-house-districts-lines');
					}
					if (showSenateDistricts) {
						populateZoomControl("senate-districts-control", "state-senate-districts", "District", "Texas Senate Districts");
						map.moveLayer('state-senate-districts-lines');
					}
					// using a timeout here to stop this from running before the big Raising School Leaders layer has finished loading
					setTimeout(function(){
						map.moveLayer('raising-blended-learners-campuses-points', 'raising-family-partnerships-points');
						map.moveLayer('charles-butt-scholars-points', 'raising-family-partnerships-points');
						map.moveLayer('raising-school-leaders-points', 'raising-family-partnerships-points');
						map.moveLayer('charles-butt-scholars-points', 'raising-texas-teachers-points');
						map.moveLayer('raising-blended-learners-campuses-points', 'raising-texas-teachers-points');
						map.moveLayer('raising-school-leaders-points', 'raising-blended-learners-points');
						map.moveLayer('raising-school-leaders-points', 'charles-butt-scholars-points');
					}, 100);
				}
			}

			function populateZoomControl(selectID, sourceID, fieldName, layerName) {
				polygons = getPolygons(sourceID, fieldName);
				var select = document.getElementById(selectID);
				select.options[0] = new Option(layerName, "-108,25,-88,37,0");
				updateURL();
				for (i in polygons) {
					select.options[select.options.length] = new Option(
						polygons[i].name,
						polygons[i].bbox.toString() + ',' + polygons[i].name
					);
					if (urlParams["zoomto"] && urlParams["zoomto"].toString() === polygons[i].name.toString()) {
						if (showHouseDistricts) {
							zoomToPolygon(sourceID, polygons[i].bbox.toString() + ',' + polygons[i].name, 'house_dist');
						} else if (showSenateDistricts) {
							zoomToPolygon(sourceID, polygons[i].bbox.toString() + ',' + polygons[i].name, 'senate_dist');
						}
					}
				}
				map.setLayoutProperty(sourceID + '-poly', 'visibility', 'none');
// IMPORTANT: these paint properties define the appearance of the mask layer that deemphasises districts outside the one we've zoomed to.  They will overrule anything that's set when that mask layer was loaded.
				map.setPaintProperty(sourceID + '-poly', 'fill-color', 'rgba(200, 200, 200, 0.7)');
				map.setPaintProperty(sourceID + '-poly', 'fill-outline-color', 'rgba(200, 200, 200, 0.1)');
			}

			function removeElement(id) {
				var elementToRemove = document.getElementById(id);
				if (elementToRemove) {
					elementToRemove.parentNode.removeChild(elementToRemove);
				}
			}

			function getPolygons(sourceID, nameField) {
				layerID = map.getSource(sourceID).vectorLayerIds[0];
				features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
				polygons = [];
				existingItems = [];
				for (i in features) {
					existing = existingItems.indexOf(features[i].properties[nameField]);
					if (existing > -1) {
						polygons[existing].bbox = getFeatureBounds(
							features[i].toJSON().geometry.coordinates,
							polygons[existing].bbox
						);
					}
					else {
						existingItems.push(features[i].properties[nameField]);
						polygons.push({
							name: features[i].properties[nameField],
							bbox: getFeatureBounds(features[i].toJSON().geometry.coordinates)
						});
					}
				}
				polygons.sort(function(a, b){
					var x = a.name;
					var y = b.name;
					if (x < y) {return -1;}
					if (x > y) {return 1;}
					return 0;
				});
				return polygons;
			}

			function getFeatureBounds(coords, startingBBOX) {
				if (startingBBOX === undefined) {
					minX = 180;
					maxX = -180;
					minY = 90;
					maxY = -90;
				}
				else {
					minX = startingBBOX[0][0];
					maxX = startingBBOX[1][0];
					minY = startingBBOX[0][1];
					maxY = startingBBOX[1][1];
				}
				for (i in coords) {
					// coords may be a simple array of coords, or an array of arrays if it's a multipolygon
					for (j in coords[i]) {
						if (!(coords[i][j][0] instanceof Array)) {
							if (coords[i][j][0] < minX) { minX = coords[i][j][0]; }
							if (coords[i][j][0] > maxX) { maxX = coords[i][j][0]; }
							if (coords[i][j][1] < minY) { minY = coords[i][j][1]; }
							if (coords[i][j][1] > maxY) { maxY = coords[i][j][1]; }
						}
						else {
							for (k in coords[i][j]) {
								if (coords[i][j][k][0] < minX) { minX = coords[i][j][k][0]; }
								if (coords[i][j][k][0] > maxX) { maxX = coords[i][j][k][0]; }
								if (coords[i][j][k][1] < minY) { minY = coords[i][j][k][1]; }
								if (coords[i][j][k][1] > maxY) { maxY = coords[i][j][k][1]; }
							}
						}
					}
				}
				return [[minX, minY], [maxX, maxY]];
			}

			// from https://www.mapbox.com/mapbox-gl-js/example/filter-features-within-map-view/
			// Because features come from tiled vector data, feature geometries may be split
			// or duplicated across tile boundaries and, as a result, features may appear
			// multiple times in query results.
			function getUniqueFeatures(array, comparatorProperty) {
				var existingFeatureKeys = {};
				var uniqueFeatures = array.filter(function(el) {
					if (existingFeatureKeys[el.properties[comparatorProperty]]) {
						return false;
					} else {
						existingFeatureKeys[el.properties[comparatorProperty]] = true;
						return true;
					}
				});

				return uniqueFeatures;
			}

			function updateURL(district='0') {
				var newURL = window.location.pathname;
				var newTitle = 'Raise Your Hand Texas programs'
				if (showHouseDistricts) {
					newURL += '?districts=house';
				} else if (showSenateDistricts) {
					newURL += '?districts=senate';
				}
				if (district === '0') {
					if (showHouseDistricts) {
						newTitle += ' by House District ';
					} else if (showSenateDistricts) {
						newTitle += ' by Senate District';
					}
				} else {
					newURL += (newURL.indexOf('?')) ? '&' : '?';
					newURL += 'zoomto=' + district;
					newTitle += ' in '
					if (showHouseDistricts) {
						newTitle += 'House ';
					} else if (showSenateDistricts) {
						newTitle += 'Senate ';
					}
					newTitle += 'District ' + district;
				}
				history.pushState({id: 'zoomto'}, newTitle, newURL);
				document.title = newTitle;
			}

// this event listener forces a page reload when going back through the history, even if only a parameter has changed
			window.addEventListener('popstate', function() {
				if (history.state && history.state.id === 'zoomto') {
					location.reload();
				}
			})

			function zoomToPolygon(sourceID, coords, filterField) {
				if (typeof coords !== 'undefined') {
					document.getElementById('statsBox').style.opacity = 0;
					coords = coords.split(",");
					bbox = [
						[coords[0], coords[1]],
						[coords[2], coords[3]]
					];
					updateURL(district=coords[4]);
					if (showHouseDistricts) {
						showHideLayer('state-house-districts-lines', markerName='state_house_districts', showOnly=true);
					} else if (showSenateDistricts) {
						showHideLayer('state-senate-districts-lines', markerName='state_senate_districts', showOnly=true);
					}
					map.fitBounds(bbox, options={padding: 10, duration: 3000});
					if (filterField !== undefined) {
						setTimeout(function(){
							for (i in loadedLineLayers) {
								showHideLayer(loadedLineLayers[i][0], loadedLineLayers[i][1], showOnly=true);
								if (
									(loadedLineLayers[i][0].indexOf("state-senate-districts") > -1)
									||
									(loadedLineLayers[i][0].indexOf("state-house-districts") > -1)
								) {
									if (coords[4] === '0') {
										map.setFilter(loadedLineLayers[i][0], null);
									} else {
										map.setFilter(
											loadedLineLayers[i][0],
											['==', 'District', parseInt(coords[4])]
										);
									}
								}
							}
							for (i in loadedPolygonLayers) {
								showHideLayer(
									loadedPolygonLayers[i][0],
									loadedPolygonLayers[i][1],
									showOnly = coords[4] === '0' ? false : true,
									hideOnly = coords[4] === '0' ? true : false
								);
								if (
									(loadedPolygonLayers[i][0].indexOf("state-senate-districts") > -1)
									||
									(loadedPolygonLayers[i][0].indexOf("state-house-districts") > -1)
								) {
									map.setFilter(
										loadedPolygonLayers[i][0],
										['!=', 'District', parseInt(coords[4])]
									);
								}

							}
							for (i in loadedPointLayers) {
								if (coords[4] === '0') {
									map.setFilter(loadedPointLayers[i][0], null);
								} else {
									map.setFilter(
										loadedPointLayers[i][0],
										['==', filterField, coords[4]]
									);
									showHideLayer(loadedPointLayers[i][0], loadedPointLayers[i][1], showOnly=true);
								}
							}
							activeDistrict = coords[4];
							if (coords[4] !== '0') {
								for (i = 500; i <= 5500; i += 1000) {
									setTimeout(function(){
										updateStatsBox(filterField);
									}, i);
								}
							} else {
								document.getElementById('statsBox').style.opacity = 0;
							}
						}, 1500);
					}
				}
			}

			function updateStatsBox(districtType) {
				if (activeDistrict !== '0') { // only do anything if we have a selected district
					document.getElementById('statsBox').style.opacity = 1;
					if (districtType.indexOf("house") > -1) {
						document.getElementById("stats.districtType").innerText = "House";
					} else if (districtType.indexOf("senate") > -1) {
						document.getElementById("stats.districtType").innerText = "Senate";
					} else {
						document.getElementById("stats.districtType").innerText = "";
					}
					document.getElementById("stats.districtName").innerText = activeDistrict;
					for (i in loadedPointLayers) {
						pointsInDistrict = getUniqueFeatures(
							map.queryRenderedFeatures( { layers:[loadedPointLayers[i][0]] } ),
							"unique_id"
						);
						counterID = "count." + loadedPointLayers[i][0];
						document.getElementById(counterID).innerText = pointsInDistrict.length;
					}
				} else {
					document.getElementById('statsBox').style.opacity = 0;
				}
			}

			function standardizeCase(txt) {
				if (txt === undefined || txt === "") {
					return "";
				} else {
					txt = txt.replace(/([^\W_]+[^\s-]*) */g, function(x) {
						return x.charAt(0).toUpperCase() + x.substr(1).toLowerCase();
					});
					txt = " " + txt + " ";
	// NB: always include the leading & trailing spaces in this list to avoid accidentally selecting substrings.  The .trim() call at the end will clean them back up.
					overrides = [
						[" Isd ", " ISD "],
						[" Cisd ", " CISD "],
						[" El ", " Elementary School "],
						[" Pri ", " Primary School "],
						[" J H ", " Junior High School " ],
						[" Junior High School Moore ", " J.H. Moore "], // comedy hour special case here, because the line above expands "J H Moore El" to "Junior High Moore Elementary School"
						[" Int ", " Intermediate School "],
						[" H S ", " High School "],
						[" Aec ", " Alternative Education Center "]
					];
					for (i in overrides) {
						txt = txt.replace(overrides[i][0], overrides[i][1]);
					}
					return txt.trim();
				}
			}
		</script>
	</head>

	<body>

	<!--BEGIN FLYOUT FOR 'ZOOM TO LAYERS'-->

		<div id="mySidenav" class="sidenav">
			<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
			<p>
				<br /><br /><br />
			</p>
			<p class="moreinfo">
				Use the drop-down menus below to zoom to a <span id="house-district-reference">House</span><span id="senate-district-reference">Senate</span> District of your choice.
				<br /><br />

				<!--Drop down controls-->

				<select id="house-districts-control" onchange="zoomToPolygon('state-house-districts', this.value, 'house_dist');"></select>
				<select id="senate-districts-control" onchange="zoomToPolygon('state-senate-districts', this.value, 'senate_dist');"></select>

				<!-- House/Senate districts switcher -->

				<p onClick="zoomToPolygon('', '-108,25,-88,37,0', '');" class="zoomoutlink"><span id="texas_icon" style="cursor:pointer"></span>Show whole state
				</p>

				<p id="switch-to-senate-districts" class="districtswitcher">
					<input type="radio" checked="true">
						<span class="checkmark"></span>Texas <b>House</b> Districts.

					<br />

					<a href="index.html?districts=senate"><input type="radio"  style="cursor:pointer" onclick="javascript:window.location.href='index.html?districts=senate'; return false;"/>
						<span class="checkmark"></span>Texas <b>Senate</b> Districts.</a>
				</p>

				<p id="switch-to-house-districts" class="districtswitcher">
					<input type="radio" checked="true">
						<span class="checkmark"></span>Texas <b>Senate</b> Districts.

					<br />

					<a href="index.html?districts=house"><input type="radio"  style="cursor:pointer" onclick="javascript:window.location.href='index.html?districts=house'; return false;"/>
						<span class="checkmark"></span>Texas <b>House</b> Districts.</a>
				</p>
			</p>

			<!--Program logos and descriptions-->

			<br />

			<a href="https://www.raiseyourhandtexas.org/foundation/blended/" class="programlink" target="_blank"><img src="images/rbl.svg" /></a>
			<button class="collapsible">Read more...</button>
			<div class="content">
			<br>
				<p class="programs">
					<a href="https://www.raiseyourhandtexas.org/foundation/blended/" class="programlink" target="_blank">Raising Blended Learners</a>  is a pilot instructional program that uses both online and brick-and-mortar strategies to create and scale a more student-centered approach to instruction in Texas. Five demonstration sites will receive up to $500,000 to implement programs. In addition, 15 districts selected as pilot networks have received implementation support.
				</p>
			</div>
			<br>
			<a href="https://www.raiseyourhandtexas.org/foundation/raising-texas-teachers/" class="programlink" target="_blank"><img src="images/rtt.svg" /></a>
			<button class="collapsible">Read more...</button>
			<div class="content">
			 <p class="programs"><a href="https://www.raiseyourhandtexas.org/foundation/raising-texas-teachers/" class="programlink" target="_blank">Raising Texas Teachers</a> is a $50 million investment over the next 10 years toward elevating the teaching profession in Texas. The program will provide $8,000 per student per year in scholarship funding for students committed to a career in teaching, in addition to technical support at 10 premier teacher preparation programs across the state. Over time, the scholarship program will grow to include 500 fellows annually.</p>
			</div>
			<br>
			<a href="https://www.raiseyourhandtexas.org/foundation/raising-school-leaders/" class="programlink" target="_blank"><img src="images/rsl.svg" /></a>
			<button class="collapsible">Read more...</button>
			<div class="content">
				<p class="programs">Through <a href="https://www.raiseyourhandtexas.org/foundation/raising-school-leaders/" class="programlink" target="_blank">Raising School Leaders</a>, Raise Your Hand Texas and the Raise Your Hand Texas Foundation have sent more than 1,000 school principals, school district teams, and other public education stakeholders to leadership development and coaching programs at Harvard University and other colleges and education organizations across the country. To date, our total investment in the program has exceeded +$15 million.</p>
			</div>
			<br>
			<a href="https://www.raiseyourhandtexas.org/foundation/raising-family-partnerships/" class="programlink" target="_blank"><img src="images/rfp.svg" /></a>
			<button class="collapsible">Read more...</button>
			<div class="content">
			 <p class="programs"><a href="https://www.raiseyourhandtexas.org/foundation/raising-family-partnerships/" class="programlink" target="_blank">Raising Family Partnerships</a> is a year-long fellowship for public school principals and their leadership teams to redesign how families, schools, and communities collaborate to improve student outcomes. To date, Raise Your Hand has invested +$300,000 in helping fellows build capacity and scale a framework for better partnerships between educators and families.</p>
			</div>

			<br>

			<p class="moreinfo">Map produced by <a href="http://www.coregis.net/" target="_blank">CoreGIS</a>.
				<br /><br />
				<a href="https://www.raiseyourhandtexas.org/" target="_blank">Raise Your Hand Texas</a>
				<br />
				<a href="https://www.raiseyourhandtexas.org/contact/" target="_blank">Contact</a>
			</p>
		</div> <!-- end of div id="mySidenav" class="sidenav" -->

		<div id="main">

			<div id="about">
				<span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Zoom to Legislative Districts</span>
			</div>

			<script>
				var coll = document.getElementsByClassName("collapsible");
				var i;

				for (i = 0; i < coll.length; i++) {
					coll[i].addEventListener("click", function() {
						this.classList.toggle("active");
						var content = this.nextElementSibling;
						if (content.style.maxHeight) {
							content.style.maxHeight = null;
						} else {
							content.style.maxHeight = content.scrollHeight + "px";
						}
					});
				}

				function openNav() {
					document.getElementById("mySidenav").style.width = "300px";
					document.getElementById("main").style.marginLeft = "300px";
				}

				function closeNav() {
					document.getElementById("mySidenav").style.width = "0";
					document.getElementById("main").style.marginLeft= "0";
				}
			</script>

		<!--END FLYOUT FOR 'ZOOM TO LAYERS'-->

		<!--BEGIN SUMMARY STATS APPEAR/DISAPPEAR WINDOW
				This bit of code creates the temporary window that appears above the legend
				and displays the summary stats for the selected district-->

			<div class='stats' id='statsBox'>
				<div class='stats-title'>
					Number of Programs in
					<br />
					<span class="select" id="stats.districtType"></span> District <span class="select" id="stats.districtName"></span>
				</div>
				<div class='stats-scale'>
					<ul class='stats-labels'>
<!-- for maintenance: always make the id of these = count.layerName because that's what the updateStatsBox() function looks for -->
						<li>Raising Blended Learners:  <span class="count.rbl" id="count.raising-blended-learners-campuses-points"></span></li>
						<li>Raising Family Partnerships: <span class="count.rfp" id="count.raising-family-partnerships-points"></span></li>
						<li>Charles Butt Scholars: <span class="count.cbs" id="count.charles-butt-scholars-points"></span></li>
						<li>Partner Universities: <span class="count.ihe" id="count.raising-texas-teachers-points"></span></li>
						<li>Raising School Leaders: <span class="count.rsl" id="count.raising-school-leaders-points"></span></li>
					</ul>
				</div> <!-- end of div class='stats-scale' -->
			</div>

		<!--END SUMMARY STATS APPEAR/DISAPPER WINDOW-->



			<div id='map'></div>

			<div class='legend'>
				<div class='legend-title'>Click on a layer name below to toggle its visibility</div>
				<div class='legend-scale'>
					<ul class='legend-labels'>
						<li onClick="showHideLayer('raising-blended-learners-campuses-points', markerName='raising_blended_learners_campuses');"><span id="raising_blended_learners_campuses" class="inactive"></span>Raising Blended Learners Campuses</li>
						<li onClick="showHideLayer('raising-family-partnerships-points', markerName='raising_family_partnerships');"><span id="raising_family_partnerships" class="inactive"></span>Raising Family Partnerships</li>
						<li onClick="showHideLayer('charles-butt-scholars-points', markerName='charles_butt_scholars');"><span id="charles_butt_scholars" class="inactive"></span>Charles Butt Scholars</li>
						<li onClick="showHideLayer('raising-texas-teachers-points', markerName='raising_texas_teachers');"><span id="raising_texas_teachers" class="inactive"></span>Partner Universities</li>
						<li onClick="showHideLayer('raising-school-leaders-points', markerName='raising_school_leaders');"><span id="raising_school_leaders" class="inactive"></span>Raising School Leaders</li>
						<li id="house_districts_legend_entry" style="display: none;" onClick="showHideLayer('state-house-districts-lines', markerName='state_house_districts');"><span id="state_house_districts" class="inactive"></span>State House Districts</li>
						<li id="senate_districts_legend_entry" style="display: none;" onClick="showHideLayer('state-senate-districts-lines', markerName='state_senate_districts');"><span id="state_senate_districts" class="inactive"></span>State Senate Districts</li>
					</ul>
				</div> <!-- end of div class='legend-scale' -->
				<div class='legend-source'>Source: <a href="https://www.raiseyourhandtexas.org/" target="_blank">Raise Your Hand Texas</a></div>
				<div class='map-credit'>Map design by <a href="http://www.coregis.net/" target="_blank">CORE GIS</a></div>
			</div> <!-- end of div id="legend" -->
		</div> <!-- end of div id="main" -->

		<script>
			// make appropriate legend entry visible, and remove whichever zoom-to-districts dropdown we're not going to be using
			if (showHouseDistricts) {
				document.getElementById("house_districts_legend_entry").style.display = "inline";
				document.getElementById("switch-to-senate-districts").style.display = "block";
				document.getElementById("house-district-reference").style.display = "inline";
			} else {
				removeElement("house-districts-control"); // the dropdown menu
			}
			if (showSenateDistricts) {
				document.getElementById("senate_districts_legend_entry").style.display = "inline";
				document.getElementById("switch-to-house-districts").style.display = "block";
				document.getElementById("senate-district-reference").style.display = "inline";
			} else {
				removeElement("senate-districts-control");
			}

			mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZS1naXMiLCJhIjoiaUxqQS1zQSJ9.mDT5nb8l_dWIHzbnOTebcQ';

			//set bounds to Texas
			var bounds = [
					[-114.9594, 21.637], // southwest coords
					[-85.50, 39.317] // northeast coords
				];
			var map = new mapboxgl.Map({
				container: 'map', // container id
				style: 'mapbox://styles/core-gis/cjbcz8eyg70il2snv8ccgahf7', // stylesheet location; this is the style with markers turned OFF
				center: [-98.887939, 31.821565], // starting position [lng, lat]
				zoom: 5.5, // starting zoom
				maxBounds: bounds // sets bounds as max
			});

			var originalZoomLevel = map.getZoom();

			var loadedPointLayers = [];
			var loadedPointLayerNames = [];
			var loadedLineLayers = [];
			var loadedPolygonLayers = [];

			function setVisibilityState(params) {
				if ((params.visibleOnLoad === undefined) || (params.visibleOnLoad === false)) {
					if ((params.legendID !== undefined) && (params.legendID !== false)) {
						document.getElementById(params.legendID).classList.add('inactive');
					}
					return 'none';
				} else {
					if ((params.legendID !== undefined) && (params.legendID !== false)) {
						document.getElementById(params.legendID).classList.remove('inactive');
					}
					return 'visible';
				}
			}

			function addPointLayer(map, params) {
				gus_api(params.gusID, function(jsondata) {
					var visibilityState = setVisibilityState(params);
					if (params.scalingFactor === undefined) { params.scalingFactor = 2.5; }
					map.addSource(params.sourceName, {
						type: 'geojson',
						data: jsondata
					});
					map.addLayer({
						'id': params.layerName,
						'type': 'symbol',
						'source': params.sourceName,
						'layout': {
							'icon-image': params.icon,
							'icon-size': params.iconSize,
							'icon-allow-overlap': true,
							'visibility': visibilityState
						}
					});
					map.on("zoomend", function(){
						map.setLayoutProperty(params.layerName, 'icon-size', (1 + (map.getZoom() / originalZoomLevel - 1) * params.scalingFactor) * params.iconSize);
					});
					loadedPointLayers.push([params.layerName, params.legendID]);
					loadedPointLayerNames.push(params.layerName)
				});
			}

			function addVectorLayer(map, params) {
				var visibilityState = setVisibilityState(params);
				map.addSource(params.sourceName, {
					type: 'vector',
					url: params.sourceURL
				});
				if ((params.lineLayerName !== undefined) && (params.lineLayerName !== false)) {
					map.addLayer(
						{
							'id': params.lineLayerName,
							'type': 'line',
							'source': params.sourceName,
							'source-layer': params.sourceID,
							'layout': {
								'visibility': visibilityState,
								'line-join': 'round',
								'line-cap': 'round'
							},
							'paint': {
								'line-color': params.lineColor,
								'line-width': 1
							},
						},
						params.displayBehind
					);
					if (params.legendID !== undefined) {
						loadedLineLayers.push([params.lineLayerName, params.legendID]);
					}
				}
				if ((params.polygonLayerName !== undefined) && (params.polygonLayerName !== false)) {
					if (params.usedInZoomControl) { visibilityState = 'visible'; }
					map.addLayer(
						{
							'id': params.polygonLayerName,
							'type': 'fill',
							'source': params.sourceName,
							'source-layer': params.sourceID,
							'layout': {
								'visibility': visibilityState
							},
							'paint': {
								'fill-color': params.polygonFillColor,
								'fill-outline-color': params.polygonOutlineColor
							},
						}
					);
					if (params.legendID !== undefined) {
						loadedPolygonLayers.push([params.polygonLayerName, params.legendID]);
					}
				}
			}



/*
	How to add point layers using the GUS API:
	Call the addPointLayer() function with arguments like the examples below.

	How to add vector layers using Mapbox:
	Call the addVectorLayer() function with arguments like the examples below.
	Note that these calls have to be after the addPointLayer() ones, because they will reference at least one of the point layers as a way of making sure polygons get drawn behind points.
*/

			map.on('load', function () {
				addPointLayer(
					map,
					{
						'gusID': "1lW_TLQ25u20FtYMsJIrgWbGvMpdkIVfehZ2wsDa8eck", // Google Sheets ID
						'sourceName': 'raising-family-partnerships', // this one will be the data source name, used internally
						'layerName': 'raising-family-partnerships-points', // layer name, used internally
						'icon': 'raising_family_partnerships_large', // this one will be the icon image name, using the name from Mapbox
						'iconSize': 0.1, // a size multiplier for the icon, which should be saved at 1/x times the intended initial display size, so that when it gets scaled up on zooming in it will still look good
						'legendID': 'raising_family_partnerships', // OPTIONAL: the id in the legend, so we can set it to active or inactive as appropriate. Simply leave out for layers that don't appear in the legend
						'scalingFactor': 2.5, // OPTIONAL: how much to magnify the markers by when zooming in.  Defaults to 2.5 if not specified; set to zero to have no zoom at all.
						'visibleOnLoad': false // set the optional final argument to true to have the layer visible on load
					}
				);

				addPointLayer(
					map,
					{
						'gusID': '1yIR3n3a7RBNlKzwU7nQsWQAPJORms_o4lmRKoST5RWU',
						'sourceName': 'raising-blended-learners-campuses',
						'layerName': 'raising-blended-learners-campuses-points',
						'icon': 'raising_blended_learners_campuses_large',
						'iconSize': 0.1,
						'legendID': 'raising_blended_learners_campuses'
					}
				);

				addPointLayer(
					map,
					{
						'gusID': "1jlfzTbBwEZVMlkGSJLf9v50vBvHeTJKq13xLus7KbC4",
						'sourceName': 'charles-butt-scholars',
						'layerName': 'charles-butt-scholars-points',
						'icon': 'charles_butt_scholars_large',
						'iconSize': 0.1,
						'legendID': 'charles_butt_scholars'
					}
				);

				addPointLayer(
					map,
					{
						'gusID': "1e24TCpzxcgbSY6CaqDUn4Ll_F36Ttc9341EXEyhpsVs",
						'sourceName': 'raising-texas-teachers',
						'layerName': 'raising-texas-teachers-points',
						'icon': 'raising_texas_teachers_large',
						'iconSize': 0.1,
						'legendID': 'raising_texas_teachers'
					}
				);

				addPointLayer(
					map,
					{
						'gusID': "1MLMUvg5WXSf3CytsEzEdVPsYPYUb_2nSXsnRnD_7Lj0",
						'sourceName': 'raising-school-leaders',
						'layerName': 'raising-school-leaders-points',
						'icon': 'raising_school_leaders_large',
						'iconSize': 0.1,
						'legendID': 'raising_school_leaders',
						'scalingFactor': 0.5
					}
				);

				if (showSenateDistricts) {
					addVectorLayer(
						map,
						{
							'sourceName': 'state-senate-districts', // data source name for internal use
							'sourceID': 'state_senate_districts-0g2odu', // name of the Mapbox layer from which the data will be loaded
							'sourceURL': 'mapbox://core-gis.b2eu90mx', // Mapbox URL
							'lineLayerName': 'state-senate-districts-lines', // OPTIONAL name we'll use for the layer that shows the outlines. Leave out or set to false if you don't want outlines displayed.
							'lineColor': '#a1b082', // colour to draw those outlines with; safe to leave out if we're not drawing outlines, but must be explicitly set if we are
							'legendID': 'state_senate_districts', // OPTIONAL: the id in the legend, so we can set it to active or inactive as appropriate. Simply leave out for layers that don't appear in the legend
							'displayBehind': 'raising-school-leaders-points', // ID of another existing layer, which Mapbox will make sure this one gets drawn behind
							'polygonLayerName': 'state-senate-districts-poly', // OPTIONAL name we'll use for the layer that invisibly stores the polygon extents. Needed if we're either going to add this layer to either the zoom to districts control or set click events (e.g. popups) on it.	Leave out or set to false if you don't want one.
							'polygonFillColor': 'rgba(200, 100, 240, 0)', // colour to fill polygons with. Needed if there's going to be a polygon layer; simply leave out if not.
							'polygonOutlineColor': 'rgba(200, 100, 240, 0)', // colour to draw polygon boundaries with. Needed if there's going to be a polygon layer; simply leave out if not.
							'visibleOnLoad': true, // set this optional argument to true to have the layer visible on load. Leave out or set to false to have it hidden on load
							'usedInZoomControl': true // set this optional argument to true if this layer will be used in the Zoom to Districts control, otherwise leave it out or set it to false.
						}
					);
				}

				if (showHouseDistricts) {
					addVectorLayer(
						map,
						{
							'sourceName': 'state-house-districts',
							'sourceID': 'state_house_districts-1vl4x8',
							'sourceURL': 'mapbox://core-gis.9drnaiu0',
							'lineLayerName': 'state-house-districts-lines',
							'lineColor': 'rgba(117, 137, 77, 0.5)',
							'legendID': 'state_house_districts',
							'displayBehind': 'raising-school-leaders-points',
							'polygonLayerName': 'state-house-districts-poly',
							'polygonFillColor': 'rgba(200, 100, 240, 0)', // IMPORTANT: the polygon fill and outline colours for House and Senate districts will be overridden by the populateZoomControl() function, so edit them there.  Here the important thing is to keep the alpha value at 0 so that the layer won't appear to blink on and off during the loading process.
							'polygonOutlineColor': 'rgba(200, 100, 240, 0)',
							'visibleOnLoad': true,
							'usedInZoomControl': true
						}
					);
				}


				// This is a special cases: the layer is never displayed, but can be used to set what will appear in popups when someone clicks on the map
				addVectorLayer(
					map,
					{
						'sourceName': 'school_house_senate_districts_UNION',
						'sourceID': 'school_house_senate_districts_UNION',
						'sourceURL': 'mapbox://core-gis.a81c8ecf',
						'displayBehind': 'districts-of-innovation-points',
						'polygonLayerName': 'school_house_senate_districts_UNION-poly',
						'polygonFillColor': 'rgba(200, 100, 240, 0)',
						'polygonOutlineColor': 'rgba(200, 100, 240, 0)',
						'usedInZoomControl': true
					}
				);

				runWhenLoadComplete();
			});

		/*

			*****************************************************
			These are the popups for the point layers
			When a click event occurs on a feature in the point layer, open a popup at
			the location of the click, with description HTML from its properties
			*****************************************************
		*/

		// generalised code to add district info
		function expandDistrictInfo(district) {
			// make sure we have a district to use
			if (district.length > 0 && district[0].layer.id === 'school_house_senate_districts_UNION-poly') {
				data = district[0].properties;
				var html = "<hr class='divider'/>";
				html += "<span class='varname'>";
				html += showHouseDistricts ? "House District: " : "Senate District: ";
				html += "</span> <span class='attribute'>";
				html += showHouseDistricts ? data.HseDistNum : data.SenDistNum;
				html += "</span>";
				return html;
			} else {
				// if there's no appropriate district match, then just return an empty string so we don't get "undefined" in the popup
				return '';
			}
		}

		//raising blended learners campuses popup
			map.on('click', 'raising-blended-learners-campuses-points', function (e) {
				var district = map.queryRenderedFeatures(e.point, {layers: ['school_house_senate_districts_UNION-poly']});
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(fillpopup_rbl(e.features[0].properties) + expandDistrictInfo(district))
					.addTo(map);
			});

			 // Change the cursor to a pointer when the mouse is over the points layer.
				map.on('mouseenter', 'raising-blended-learners-campuses-points', function () {
					map.getCanvas().style.cursor = 'pointer';
				});

				// Change it back to a pointer when it leaves.
				map.on('mouseleave', 'raising-blended-learners-campuses-points', function () {
					map.getCanvas().style.cursor = '';
				});

			function fillpopup_rbl(data){
				var html = "";
				html = html + "<span class='varname'>School: </span> <span class='attribute'>" + data.school + "</span>";
				html = html + "<br />"
				html = html + "<span class='varname'>Grades: </span> <span class='attribute'>" + data.grades + "</span>";
				html = html + "<br />"
				html = html + "<span class='varname'>Subjects: </span> <span class='attribute'>" + data.subjects + "</span>";
				html = html + "<br />"
				html = html + "<span class='varname'>School District: </span> <span class='attribute'>" + data.district + "</span>";
				return html;
				//this will return the string to the calling function

			}

		//raising family partnerships popup
			map.on('click', 'raising-family-partnerships-points', function (e) {
				var district = map.queryRenderedFeatures(e.point, {layers: ['school_house_senate_districts_UNION-poly']});
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(fillpopup_rfp(e.features[0].properties) + expandDistrictInfo(district))
					.addTo(map);
			});

			 // Change the cursor to a pointer when the mouse is over the points layer.
				map.on('mouseenter', 'raising-family-partnerships-points', function () {
					map.getCanvas().style.cursor = 'pointer';
				});

				// Change it back to a pointer when it leaves.
				map.on('mouseleave', 'raising-family-partnerships-points', function () {
					map.getCanvas().style.cursor = '';
				});

			function fillpopup_rfp(data){
				var html_rfp = "";
				html_rfp = html_rfp + "<span class='varname'>School: </span> <span class='attribute'>" + standardizeCase(data.account_name) + "</span>";
				return html_rfp;
				//this will return the string to the calling function

			}

		//charles butt scholars popup
			map.on('click', 'charles-butt-scholars-points', function (e) {
				var district = map.queryRenderedFeatures(e.point, {layers: ['school_house_senate_districts_UNION-poly']});
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(fillpopup_cbs(e.features[0].properties) + expandDistrictInfo(district))
					.addTo(map);
			});

			 // Change the cursor to a pointer when the mouse is over the points layer.
				map.on('mouseenter', 'charles-butt-scholars-points', function () {
					map.getCanvas().style.cursor = 'pointer';
				});

				// Change it back to a pointer when it leaves.
				map.on('mouseleave', 'charles-butt-scholars-points', function () {
					map.getCanvas().style.cursor = '';
				});

			function fillpopup_cbs(data){
				var html = "";
				html = html + "<span class='varname'>Scholar's Name: </span> <span class='attribute'>" + data.full_name + "</span>";
				html = html + "<br />"
				html = html + "<span class='attribute'>" + '<a href="' + data.cb_scholar_url + '"' + " target='_blank'" + '>' + data.link + '</a>'+"</span>";
				return html;
				//this will return the string to the calling function

			}

		//institutes for higher education popup
			map.on('click', 'raising-texas-teachers-points', function (e) {
				var district = map.queryRenderedFeatures(e.point, {layers: ['school_house_senate_districts_UNION-poly']});
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(fillpopup_rtt(e.features[0].properties) + expandDistrictInfo(district))
					.addTo(map);
			});

			 // Change the cursor to a pointer when the mouse is over the points layer.
				map.on('mouseenter', 'raising-texas-teachers-points', function () {
					map.getCanvas().style.cursor = 'pointer';
				});

				// Change it back to a pointer when it leaves.
				map.on('mouseleave', 'raising-texas-teachers-points', function () {
					map.getCanvas().style.cursor = '';
				});

			function fillpopup_rtt(data){
				var html = "";
				html = html + "<span class='varname'>Institute: </span> <span class='attribute'>" + data.account_name + "</span>";
				return html;
				//this will return the string to the calling function

			}


		//raising school leaders popup
			map.on('click', 'raising-school-leaders-points', function (e) {
				var district = map.queryRenderedFeatures(e.point, {layers: ['school_house_senate_districts_UNION-poly']});
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(fillpopup_rsl(e.features[0].properties) + expandDistrictInfo(district))
					.addTo(map);
			});

			 // Change the cursor to a pointer when the mouse is over the points layer.
				map.on('mouseenter', 'raising-school-leaders-points', function () {
					map.getCanvas().style.cursor = 'pointer';
				});

				// Change it back to a pointer when it leaves.
				map.on('mouseleave', 'raising-school-leaders-points', function () {
					map.getCanvas().style.cursor = '';
				});

			function fillpopup_rsl(data){
				var html = "";
				html = html + "<span class='varname'>Institute: </span> <span class='attribute'>" + data.institute + "</span>";
				html = html + "<br />"
				html = html + "<span class='varname'>Campus: </span> <span class='attribute'>" + standardizeCase(data.campus) + "</span>";
				if (data.district) {
					html = html + "<br />"
					html = html + "<span class='varname'>School District: </span> <span class='attribute'>" + standardizeCase(data.district) + "</span>";
				}
				return html;
				//this will return the string to the calling function

			}

// These are the popups for the polygon district layers, using Eldan's House/Senate 'show' logic
// When a click event occurs on a feature in the unioned districts layer, open a popup for
// the correct district type at the location of the click, with description HTML from its properties.
			function fillpopup(data) {
				var html = "<span class='varname'>";
// the shorthand in this next line is just a compressed if...then.
// "if showHouseDistricts is true then use the first string, else the second"
				html += showHouseDistricts ? "House District: " : "Senate District: ";
				html += "</span><span class='attribute'>";
				html += showHouseDistricts ? data.HseDistNum : data.SenDistNum;
				html += "</span>";
				return html; //this will return the string to the calling function
			}

			map.on('click', 'school_house_senate_districts_UNION-poly', function (e) {
				var pointFeatures = map.queryRenderedFeatures(e.point, {layers: loadedPointLayerNames});
				if (pointFeatures.length === 0) {
					new mapboxgl.Popup()
						.setLngLat(e.lngLat)
						.setHTML(fillpopup(e.features[0].properties))
						.addTo(map);
				}
			});

// Change the cursor to a pointer when the mouse is over the house districts layer.
			map.on('mouseenter', 'school_house_senate_districts_UNION-poly', function () {
				map.getCanvas().style.cursor = 'pointer';
			});

// Change it back to a pointer when it leaves.
			map.on('mouseleave', 'school_house_senate_districts_UNION-poly', function () {
				map.getCanvas().style.cursor = '';
			});


		//****************END POP UPS****************

			function fetchJSONFile(path, callback) {
				var httpRequest = new XMLHttpRequest();
				httpRequest.onreadystatechange = function() {
					if (httpRequest.readyState === 4) {
						if (httpRequest.status === 200) {
							var data = JSON.parse(httpRequest.responseText);
							if (callback) callback(data);
						}
					}
				};
				httpRequest.open('GET', path);
				httpRequest.send();
			}



			function gus_api(id, callback) {
				const url = `https://spreadsheets.google.com/feeds/cells/${id}/od6/public/basic?alt=json`;

				fetchJSONFile(url, function(data) {

					let headers = {};
					let entries = {};

					data.feed.entry.forEach((e) => {
						// get the row number
						const row = parseInt(e.title['$t'].match(/\d+/g)[0]);
						const column = e.title['$t'].match(/[a-zA-Z]+/g)[0];
						const content = e.content['$t'];

						// it's a header
						if (row === 1) {
							headers[column] = content;
						} else {
							if (!entries[row]) entries[row] = {};
							entries[row][headers[column]] = content;
						}
					});

					const gj = { type: 'FeatureCollection', features: [] };
					for (let e in entries) {

						const feature = {
							type: 'Feature',
							geometry: {
								type: 'Point',
								coordinates: [0, 0]
							},
							properties: entries[e]
						};

						for (let p in entries[e]) {
							switch(p.toLowerCase()) {
								case 'longitude':
								case 'long':
								case 'lng':
								case 'lon':
								case 'x':
								case 'xcoord':
									feature.geometry.coordinates[0] = parseFloat(entries[e][p]);
								case 'latitude':
								case 'lat':
								case 'y':
								case 'ycoord':
									feature.geometry.coordinates[1] = parseFloat(entries[e][p]);
							}
						}

						gj.features.push(feature);
					}

					callback(gj);
				});
			};
		</script>

	</body>
</html>
